WITH 
Exp_db_cmnct_fact_detail AS (
    SELECT DISTINCT
        platform_id AS platform_id,
        client_id AS client_id,
        platform_person_internal_id AS Person_Internal_ID,
                                assumed_termination_date AS termination_date,
  date( activity_initiated_cst_ts)AS event_start_timestamp,
  date( intent_retire_activity_completed_cst_ts) AS iret_event_end_timestamp,
     trim(commencement_status) AS event_status,
  benefit_commencement_date,plan_id,
  start_channel as Pesion_commencement_event_start_channel,
-- result_channel as Pension_Commencement_Complete_Cancel_Expire_Channel,
CASE 

            WHEN trim(result_channel) in ( 'A','Admin') THEN 'Admin'

            WHEN trim(result_channel) in ('B','Batch') THEN 'Batch'

            WHEN trim(result_channel) in  ('D','Form') THEN 'Form'

            WHEN trim(result_channel) in  ('T','Telephone Representative','Telephone Rep.') THEN 'Telephone Representative'

            WHEN trim(result_channel) in ('U','UPoint') THEN 'UPoint'

            WHEN trim(result_channel)in ('W','Web') THEN 'Web'

        END AS Pension_Commencement_Complete_Cancel_Expire_Channel,

  commencement_result_elapsed_days AS elapsed_time_in_days,
  'elapsed_time' AS summary_dimension_type
    FROM wealth_rpt.db_commencement db_commencement_detail
    WHERE client_id IN (cast(<<$pClientId>> as int)) 
      AND activity_initiated_cst_ts >= '1800-01-01'
                  AND commencement_result_elapsed_days IS NOT NULL
),

mv_person
AS (
    SELECT DISTINCT 
        p.global_client_id,
        p.global_person_id,
        p.client_id,
        p.client_id_string,
        p.platform_person_internal_id,
        p.platform_id,
        p.gender,
        p.birth_date,
        p.person_reason_code,
        p.is_bad_permanent_address,
        p.union_name,
        CASE 
            WHEN UPPER(p.marital_status) LIKE 'MARRIED%' THEN 'Y' 
            ELSE 'N' 
        END AS marital_status,
        p.last_name,
        p.middle_name,
        p.first_name,     
        LAST_DAY(e.iret_event_end_timestamp) AS reporting_month
    FROM person_rpt.person AS p  
    INNER JOIN Exp_db_cmnct_fact_detail AS e
        ON p.platform_person_internal_id = e.Person_Internal_ID
        AND p.client_id = e.client_id
        AND p.begin_date <= LAST_DAY(e.iret_event_end_timestamp)
        AND p.end_date >= LAST_DAY(e.iret_event_end_timestamp)

 WHERE p.client_id IN (cast(<<$pClientId>> as int))

)
,
psf AS (select * from person_itg.person_security_filter 
                                                 where client_id =cast(cast(<<$pClientId>> as int) as int) 
                                                                
),
pcf AS (select * 
        from person_itg.person_custom_filter 
                    where client_id =cast(cast(<<$pClientId>> as int) as int) and data_product = 'DB'
                                and begin_date <= <<$pAsOfDate>>
                     AND end_date >= <<$pAsOfDate>>
),

mv_person_employment
AS (
SELECT DISTINCT 
 pe.global_client_id,
        pe.global_person_id,
        pe.client_id,
        pe.platform_person_internal_id,
        pe.platform_id,

  CAST(COALESCE(pe.expected_annual_base_salary, 0) AS NUMERIC(19,4)) AS expected_annual_base_salary,
        pe.hourly_salary_status,
        pe.fulltime_parttime_status,
        s.standard_value AS employment_status,
        pe.hire_date,
        CASE 
            WHEN EXTRACT(YEAR FROM pe.termination_date) < 1900 THEN NULL 
            ELSE pe.termination_date 
        END AS termination_date,
        pe.employee_id,
        pe.employment_status_begin_date,
        LAST_DAY(e.iret_event_end_timestamp) AS reporting_month

    FROM person_rpt.person_employment AS pe
    INNER JOIN Exp_db_cmnct_fact_detail AS e
        ON pe.platform_person_internal_id = e.Person_Internal_ID
        AND pe.client_id = e.client_id
        AND pe.begin_date <= LAST_DAY(e.iret_event_end_timestamp)
        AND pe.end_date >= LAST_DAY(e.iret_event_end_timestamp)

 left join (select distinct standard_key,standard_value from adlfound_itg.standard_rollups_lookup where 
standard_group_key in ('EMPL-STAT-CD-ROLLUP1') ) s
on trim(pe.standard_employment_status_code)=(standard_key)
WHERE pe.client_id = cast(cast(<<$pClientId>> as int) as int)
),

person
AS (
SELECT p.global_client_id
  ,p.global_person_id
  ,p.client_id
  ,p.client_id_string
  ,p.platform_person_internal_id
  ,p.platform_id
  ,e.expected_annual_base_salary as expected_annual_base_salary
  ,e.hourly_salary_status
  ,e.fulltime_parttime_status
  ,e.employment_status
  ,p.person_reason_code  
  ,p.union_name
  ,p.gender
  ,e.hire_date as hire_date
  ,p.last_name
  ,p.middle_name
  ,p.first_name
  ,p.is_bad_permanent_address
  ,e.employee_id
  ,p.birth_date
  ,e.employment_status_begin_date
  ,p.reporting_month
  ,CASE 
   WHEN p.birth_date IN (
     '1800-01-01'
     ,'1900-01-01'
     ,'1901-01-01'
     ,'1910-01-01'
     ,'1930-01-01'
     )
    THEN NULL
   ELSE ROUND(DATEDIFF(DAY, p.birth_date,  p.reporting_month) / 365.25, 2)
   END AS age
  ,CASE 
   WHEN p.person_reason_code = 'Employee'
     AND upper(e.employment_status) = 'ACTIVE'
    THEN ROUND(DATEDIFF(DAY, e.hire_date,  e.reporting_month) / 365.25, 2)
   WHEN p.person_reason_code = 'Employee'
    AND upper(e.employment_status) <> 'ACTIVE'
    AND e.termination_date IS NOT NULL
    AND EXTRACT(YEAR FROM e.termination_date) <> 2299
    THEN ROUND(DATEDIFF(DAY, e.hire_date, e.termination_date) / 365.25, 2)
   ELSE NULL
   END AS tenure,  p.marital_status,e.termination_date,
   psf.row_level_security_filter_value,
    pcf.custom_filter_1, pcf.custom_filter_2, pcf.custom_filter_3, pcf.custom_filter_4, pcf.custom_filter_5      
FROM mv_person p
left join psf on p.platform_id = psf.platform_id
                                                                                                                                and p.platform_person_internal_id = psf.platform_person_internal_id
                                                                                                                                and p.client_id = psf.client_id                                                  
                
left join pcf on p.platform_id = pcf.platform_id
                                                                                                                                and p.platform_person_internal_id = pcf.platform_person_internal_id
                                                                                                                                and p.client_id = pcf.client_id 
                                                                                                                --             and p.begin_date <= pcf.end_date
                                                                                                                --             and p.end_date >= pcf.begin_date

 LEFT JOIN mv_person_employment e ON p.client_id = e.client_id
  AND p.platform_person_internal_id = e.platform_person_internal_id
  AND p.platform_id = e.platform_id
  AND  e.reporting_month=p.reporting_month
--  AND p.global_client_id = e.global_client_id
-- AND p.global_person_id = e.global_person_id
  AND p.client_id IN ( cast(<<$pClientId>> as int))
)
,
db_plan_dim as (select distinct client_id,plan_id,plan_ldsc_tx from wealth_rpt.db_plan_dim where client_id IN ( cast(<<$pClientId>> as int))
)
,
-- PRSN_PLANSTAT_DIMN01
--AS (
-- SELECT a.client_id AS CLIENT_ID
-- ,a.platform_id
--  ,a.platform_person_internal_id AS PRSN_INTN_ID
--  ,a.category_id AS CAT_ID
--  ,a.begin_date AS PP_STAT_EFBEG_DT
--  ,a.end_date AS PP_STAT_EFEND_DT
--  ,a.plan_status_code AS PLAN_STAT_CD
--  ,plan_status_description as plan_stat_tx
--  ,a.participation_status_code AS prtc_stat_cd
--  ,a.platform_indicator_code AS PLFM_IND_CD
--  ,a.plan_id AS PLAN_ID
--  ,c.plan_ldsc_tx as Plan_Description
--  ,b.category_type_code AS CAT_TYPE_CD
--  ,MAX(begin_date) OVER (
--   PARTITION BY a.client_id
--   ,a.plan_id
--   ,a.platform_person_internal_id
--   ,a.category_id
--   ) AS MAX_PP_STAT_EFBEG_DT
-- FROM wealth_rpt.person_planstatus_dim a
-- 
-- 
--
-- INNER JOIN wealth_rpt.dc_category_dim b ON a.client_id = b.client_id
--  AND a.category_id = b.category_id
--  AND a.plan_id = b.plan_id
-- INNER JOIN wealth_rpt.db_plan_dim c on  a.client_id = c.client_id
--  AND a.plan_id = c.plan_id
-- WHERE
--  a.platform_indicator_code IN ('R3','R4','DBE') 
--  AND b.category_type_code = 'PS'
--  AND (<<$pAsOfDate>>) >= a.begin_date
--  AND (<<$pAsOfDate>>) <= a.end_date
--  AND b.category_definition_brand_code = 'DB-AVLB'
--  AND a.client_id =cast(<<$pClientId>> as int)
-- )
-- ,PRSN_PLANSTAT_DIMN
--AS (
-- SELECT DISTINCT CLIENT_ID
-- ,platform_id
--  ,PLAN_ID
--  ,Plan_Description
--  ,CAT_ID
--  ,PRSN_INTN_ID
--  ,prtc_stat_cd
--  ,plfm_ind_cd
--  ,CAT_TYPE_CD
--  ,plan_stat_tx
--  ,MAX_PP_STAT_EFBEG_DT
-- FROM PRSN_PLANSTAT_DIMN01
-- WHERE MAX_PP_STAT_EFBEG_DT = PP_STAT_EFBEG_DT
--  AND CLIENT_ID NOT IN (1852)
-- )
-- ,

 person_planstat
AS (
SELECT p.global_client_id
  ,p.global_person_id
  ,p.client_id
  ,p.platform_id
  ,p.client_id_string
  ,p.birth_date
  ,p.platform_person_internal_id
  ,p.expected_annual_base_salary
  ,p.hourly_salary_status
  ,p.fulltime_parttime_status
  ,p.person_reason_code
  ,p.is_bad_permanent_address
  ,p.union_name
  ,p.gender
  ,p.employment_status
  ,p.age
  ,p.tenure
  ,p.marital_status
  ,p.reporting_month
--  ,d.prtc_stat_cd
-- ,d.plfm_ind_cd
-- ,d.plan_id
--  ,d.Plan_Description
  ,p.first_name
  ,p.middle_name
  ,p.last_name
  ,p.employment_status_begin_date
  ,p.employee_id
  ,p.hire_date
  ,p.termination_date
-- ,d.plan_stat_tx
  ,p.row_level_security_filter_value,
    p.custom_filter_1, p.custom_filter_2, p.custom_filter_3, p.custom_filter_4, p.custom_filter_5
  
 FROM person p
-- prsn_planstat_dimn d
-- right JOIN person p ON p.client_id = d.client_id
--  AND p.platform_person_internal_id = d.prsn_intn_id
--  AND p.platform_id = d.platform_id
--WHERE 
 --d.plfm_ind_cd IN ('R3','R4','DBE') 
  --AND
  --UPPER(TRIM(p.employment_status)) = 'ACTIVE'
  --AND UPPER(TRIM(prtc_stat_cd)) = 'ACTIVE'
)
,person_data

AS (
SELECT a.client_id, a.global_client_id, global_person_id
,a.client_id_string
,a.platform_id
  ,a.platform_person_internal_id
  ,a.expected_annual_base_salary AS salary
  ,a.hourly_salary_status
  ,a.fulltime_parttime_status
  ,a.person_reason_code
  ,a.union_name
  ,a.is_bad_permanent_address
  ,a.gender
  ,a.employment_status_begin_date
  ,a.first_name
  ,a.middle_name
  ,a.last_name
  ,a.employee_id
  ,a.birth_date
  ,a.marital_status
  ,a.employment_status
  ,a.reporting_month
  ,(a.age) as age
  ,(a.tenure) as tenure
  ,a.hire_date
--  ,a.prtc_stat_cd
-- ,a.plfm_ind_cd
-- ,a.plan_id
--  ,a.Plan_Description
--  ,a.plan_stat_tx
  ,a.termination_date
  , a.row_level_security_filter_value,
    a.custom_filter_1, a.custom_filter_2, a.custom_filter_3, a.custom_filter_4, a.custom_filter_5
FROM person_planstat a

 )

 ,range_lookup
AS (
SELECT standard_group_key
  ,standard_display_name standard_display_value
  ,standard_min
  ,standard_max
  ,OWNER
FROM adlfound_itg.standard_ranges_lookup
)
,person_attributes
AS (
SELECT a.global_client_id
  ,a.global_person_id
  ,a.client_id
  ,a.platform_id
  ,a.client_id_string
  ,a.platform_person_internal_id
  ,a.hourly_salary_status
  ,a.fulltime_parttime_status
  ,a.employment_status
  ,a.person_reason_code
  ,a.union_name
  ,a.gender
  ,a.hire_date
  ,a.last_name
  ,a.middle_name
  ,a.first_name
  ,a.employee_id
  ,a.birth_date
  ,a.salary
  ,a.age
  ,a.marital_status
  ,a.termination_date
  ,a.employment_status_begin_date
  ,a.reporting_month
--  ,a.prtc_stat_cd
--  ,a.plfm_ind_cd
--  ,a.plan_id
--  ,a.Plan_Description
--  ,a.plan_stat_tx
    ,b.standard_display_value AS AGE_RANGE
  
  
  ,C.standard_display_value AS TENURE_RANGE
  
  ,D.standard_display_value AS SALARY_RANGE
  , a.row_level_security_filter_value,
    a.custom_filter_1, a.custom_filter_2, a.custom_filter_3, a.custom_filter_4, a.custom_filter_5
  
 FROM person_data a
LEFT JOIN (
  SELECT *
  FROM range_lookup
  WHERE standard_group_key = 'AGE_RANGE_DB'
  ) b ON floor(a.age) between b.standard_min AND b.standard_max
LEFT JOIN (
  SELECT *
  FROM range_lookup
  WHERE standard_group_key = 'TENURE'
  ) C ON floor(a.tenure) between C.standard_min AND C.standard_max
LEFT JOIN (
  SELECT *
  FROM range_lookup
  WHERE standard_group_key = 'SALARY_RANGE_WEALTH'
  ) D ON floor(a.salary) between D.standard_min AND D.standard_max 
 ),

Exp_cmnct_of_benefit_init_comm AS (
SELECT DISTINCT 
Exp_db_cmnct_fact_detail.platform_id as platform_id,
person_attributes.client_id as Client_ID,
person_attributes.client_id_string, 
Exp_db_cmnct_fact_detail.Person_Internal_ID as Person_Internal_ID,
person_attributes.employee_id  as Employee_ID ,
person_attributes.last_name as Last_Name ,
person_attributes.first_name as First_Name ,
person_attributes.middle_name as Middle_Name ,
person_attributes.gender  as Gender ,
person_attributes.birth_date as Birth_Date ,
Exp_db_cmnct_fact_detail.iret_event_end_timestamp,
Exp_db_cmnct_fact_detail.elapsed_time_in_days,
person_attributes.person_reason_code as Person_Type ,
person_attributes.hire_date as Hire_Date,
person_attributes.employment_status  as Employment_Status ,
person_attributes.age,
person_attributes.salary,
person_attributes.AGE_RANGE as Age_Range,
person_attributes.SALARY_RANGE as Salary_Range,
person_attributes.TENURE_RANGE as Employment_Range,
person_attributes.fulltime_parttime_status as FullTime_PartTime,
person_attributes.hourly_salary_status as Salary_Hourly,
person_attributes.union_name as Union_name,
person_attributes.marital_status as Spouse_On_File_Flag,
Exp_db_cmnct_fact_detail.termination_date as Term_Date_Assumption,
person_attributes.employment_status_begin_date as Employment_Status_Begin_Date 
-- , p.prtc_stat_cd
-- ,p.plfm_ind_cd
  ,Exp_db_cmnct_fact_detail.plan_id
  ,PL.plan_ldsc_tx as Plan_Description,
--  ,p.plan_stat_tx,
  Exp_db_cmnct_fact_detail.Benefit_Commencement_Date,
  Exp_db_cmnct_fact_detail.event_start_timestamp as reporting_month_date,
--'Initiated Commencement' AS Pension_commencement_status,
'Initiated' AS Pension_commencement_status,
Exp_db_cmnct_fact_detail.Pension_Commencement_Complete_Cancel_Expire_Channel,
'NA' as Pension_Commencement_Complete_Cancel_Expire_Elapsed_Time__Days,
person_attributes.row_level_security_filter_value,
person_attributes.custom_filter_1, person_attributes.custom_filter_2, person_attributes.custom_filter_3, person_attributes.custom_filter_4, person_attributes.custom_filter_5,
'Initiated Commencement' AS summary_dimension_value,
summary_dimension_type
FROM Exp_db_cmnct_fact_detail inner join person_attributes person_attributes on Exp_db_cmnct_fact_detail.Person_Internal_ID=person_attributes.platform_person_internal_id
and Exp_db_cmnct_fact_detail.client_id=person_attributes.client_id 
and Exp_db_cmnct_fact_detail.platform_id=person_attributes.platform_id 
and person_attributes.reporting_month=last_day(iret_event_end_timestamp)
--and Exp_db_cmnct_fact_detail.plan_id=person_attributes.plan_id 
--left join 
--PRSN_PLANSTAT_DIMN p 
--on
--Exp_db_cmnct_fact_detail.person_internal_id=p.prsn_intn_id
--and Exp_db_cmnct_fact_detail.client_id=p.client_id 
--and Exp_db_cmnct_fact_detail.platform_id=p.platform_id 
--and Exp_db_cmnct_fact_detail.plan_id=p.plan_id
left join 
db_plan_dim PL
on 
Exp_db_cmnct_fact_detail.client_id=PL.client_id
and Exp_db_cmnct_fact_detail.plan_id=PL.plan_id

),

join_plan_prsn_atrb_comnc_fact AS (
    SELECT DISTINCT
        a.platform_id,
        a.client_id,
        a.person_internal_id,
                                a.elapsed_time_in_days AS elapsed_time_in_days,
        a.summary_dimension_type,                          
                                a.client_id_string,
                                a.Employee_ID,
                                a.Gender,
                                a.Birth_Date,                    
                                a.Person_Type,
                                a.Hire_Date,
                                --a.Employment_Status,
                                a.age,
                                a.salary,
                                a.Age_Range,
                                a.Salary_Range,
                                a.Employment_Range,
                                a.FullTime_PartTime,
                                a.Salary_Hourly,
                                a.Union_name,
                                a.Spouse_On_File_Flag,
                                a.Term_Date_Assumption,
        a.Employment_Status_Begin_Date ,
                                --a.prtc_stat_cd,a.plfm_ind_cd,
                                a.plan_id,
                                a.Plan_Description,
                                --a.plan_stat_tx,
                                
                a.Benefit_Commencement_Date,a.Pension_Commencement_Complete_Cancel_Expire_Channel,a.row_level_security_filter_value,a.custom_filter_1,a.custom_filter_2,a.custom_filter_3,a.custom_filter_4,a.custom_filter_5,                                
        DATEADD(day, -1, DATEADD(month, 1, DATE_TRUNC('month', a.iret_event_end_timestamp))) AS reporting_month_date,
                                CASE WHEN nvl(trim(s.standard_value),'') IS NULL then 'NA' else nvl(trim(s.standard_value),'') END AS employment_status,b.begin_date ,b.end_date
                                FROM Exp_cmnct_of_benefit_init_comm a
    INNER JOIN person_rpt.person_employment b ON a.platform_id = b.platform_id 
        AND a.client_id = b.client_id
        AND a.person_internal_id = b.platform_person_internal_id 
                                AND DATEADD(day, -1, DATEADD(month, 1, DATE_TRUNC('month', a.iret_event_end_timestamp))) >= CAST(b.begin_date AS DATE)
        AND DATEADD(day, -1, DATEADD(month, 1, DATE_TRUNC('month', a.iret_event_end_timestamp))) <= CAST(b.end_date AS DATE)
                                left join (select distinct standard_key,standard_value from adlfound_itg.standard_rollups_lookup where 
standard_group_key in ('EMPL-STAT-CD-ROLLUP1') ) s
on trim(b.standard_employment_status_code)=(standard_key)
                                ),                             
                                
Exp_elpsed_time_cmnct_smry_distinct_count as (
SELECT
platform_id,
client_id,
person_internal_id,
summary_dimension_type,
client_id_string,
Gender,
Birth_Date,                        
Person_Type,
Hire_Date,
employment_status,
age,
salary,
Age_Range,
Salary_Range,
Employment_Range,
FullTime_PartTime,
Salary_Hourly,
Union_name,
Spouse_On_File_Flag,
Term_Date_Assumption,
Employment_Status_Begin_Date, 
--prtc_stat_cd,
--plfm_ind_cd,
plan_id,
Plan_Description,
--plan_stat_tx,
Benefit_Commencement_Date,
Pension_Commencement_Complete_Cancel_Expire_Channel,
row_level_security_filter_value,
custom_filter_1,
custom_filter_2,
custom_filter_3,
custom_filter_4,
custom_filter_5,
reporting_month_date,
SUM(elapsed_time_in_days) AS generic_column_9,

count(distinct person_internal_id) AS employee_distinct_count_month
from join_plan_prsn_atrb_comnc_fact
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32
),

exp_average_elp_days_cmnct_days  as (SELECT
platform_id,
client_id,
NVL(TRIM(summary_dimension_type), '') AS smry_dimn_type,
client_id_string,
person_internal_id,
Gender,
Birth_Date,                        
Person_Type,
Hire_Date,
employment_status AS empl_stat,
age,
salary,
Age_Range,
Salary_Range,
Employment_Range,
FullTime_PartTime,
Salary_Hourly,
Union_name,
Spouse_On_File_Flag,
Term_Date_Assumption,
Employment_Status_Begin_Date, 
--prtc_stat_cd,
--plfm_ind_cd,
plan_id,
Plan_Description,
--plan_stat_tx,
Benefit_Commencement_Date,
Pension_Commencement_Complete_Cancel_Expire_Channel,
row_level_security_filter_value,
custom_filter_1,
custom_filter_2,
custom_filter_3,
custom_filter_4,
custom_filter_5,
cast(generic_column_9 as int) AS gnrc_col_9,
reporting_month_date AS reporting_month_dt,
CAST(employee_distinct_count_month AS INT) AS employee_distinct_count_month,
CAST(CASE WHEN employee_distinct_count_month IS NULL then 0 else employee_distinct_count_month END AS INT) AS empl_dist_cnt_mnth
from Exp_elpsed_time_cmnct_smry_distinct_count
)

SELECT 
platform_id,
client_id,
smry_dimn_type,
client_id_string,
person_internal_id,
Gender,
Birth_Date,                        
Person_Type,
Hire_Date,
empl_stat,
age,
salary,
Age_Range,
Salary_Range,
Employment_Range,
FullTime_PartTime,
Salary_Hourly,
Union_name,
Spouse_On_File_Flag,
Term_Date_Assumption,
Employment_Status_Begin_Date, 
--prtc_stat_cd,
--plfm_ind_cd,
plan_id,
Plan_Description,
--plan_stat_tx,
Benefit_Commencement_Date,
Pension_Commencement_Complete_Cancel_Expire_Channel,
row_level_security_filter_value,
custom_filter_1,
custom_filter_2,
custom_filter_3,
custom_filter_4,
custom_filter_5,
gnrc_col_9,
employee_distinct_count_month,
empl_dist_cnt_mnth,
reporting_month_dt AS Reporting_Month_Date,
CAST(SUM(gnrc_col_9) AS DOUBLE PRECISION) / SUM(empl_dist_cnt_mnth) AS Average_number_of_Elapse_Days

FROM
    exp_average_elp_days_cmnct_days
WHERE 
    smry_dimn_type = 'elapsed_time' AND
--   reporting_month_dt <= LAST_DAY(ADD_MONTHS(CURRENT_DATE, -1)) AND
--   reporting_month_dt >= ADD_MONTHS(LAST_DAY(ADD_MONTHS(CURRENT_DATE, -1)), -11)
      reporting_month_dt <= LAST_DAY(<<$pAsOfDate>>) AND
      reporting_month_dt >= ADD_MONTHS(LAST_DAY(ADD_MONTHS(<<$pAsOfDate>>, 0)), -11)
   
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35