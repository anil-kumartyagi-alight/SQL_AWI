WITH 
mv_person AS 
    (
    SELECT
	DISTINCT global_client_id
                                ,global_person_id
                                ,client_id, client_id_string
                                ,platform_person_internal_id
                                ,gender
								,standard_gender AS SEX_CD
                                ,CASE 
                                 WHEN birth_date IN (
                                 '1800-01-01'
                                 ,'1900-01-01'
                                 ,'1901-01-01'
                                 ,'1910-01-01'
                                 ,'1930-01-01'
								 ,'0001-12-30 BC'
                                 ) THEN NULL
                                ELSE birth_date end as birth_date
                                ,person_reason_code
                                ,union_name
								, platform_id
								,begin_date
								,end_date
        ,PRSN_DIMN7.last_name AS LAST_NM 
        ,PRSN_DIMN7.first_name AS FRST_NM
        ,PRSN_DIMN7.middle_name AS MID_NM 
       ,PRSN_DIMN7.is_bad_preferred_address  as BAD_ADDR_IND_CD

	   ,row_level_security_filter_value

                FROM person_rpt.person PRSN_DIMN7
                WHERE
-- person_reason_code in( 'Employee','QDRO','Beneficiary' )AND 
								begin_date <= <<$pEndDate>>
                                AND end_date >= <<$pEndDate>>
                                 AND client_id = cast(<<$pClientId>> as int)
    )
--select * from mv_person
, 

mv_person_employment
AS (
                SELECT DISTINCT global_client_id
                                ,global_person_id
                                ,client_id
                                ,platform_person_internal_id
								,platform_id
                                ,expected_annual_base_salary
                                ,hourly_salary_status
                                ,fulltime_parttime_status
                                ,standard_employment_status as employment_status
                                ,hire_date
                                ,termination_date
								,employment_status_begin_date as effective_begin_date
								,employee_id
								,standard_value as employment_status_roll_up_1
                FROM person_rpt.person_employment
				left join (select distinct standard_key,standard_value from adlfound_itg.standard_rollups_lookup where 
standard_group_key in ('EMPL-STAT-CD-ROLLUP1') ) s
on trim(standard_employment_status_code)=(standard_key)
WHERE 
				--upper(trim(employment_status)) in  ('ACTIVE','INACTIVE')AND 
				begin_date <= <<$pEndDate>>
                                AND end_date >= <<$pEndDate>>
                                AND client_id = cast(<<$pClientId>> as int)
                )
,
pcf
AS (
				select * from person_itg.person_custom_filter 
				where client_id =cast(<<$pClientId>> as int) 
				and data_product = 'DB'
				and begin_date <= <<$pEndDate>>
                     AND end_date >= <<$pEndDate>>
				)			
				
                ,person
AS (
                SELECT p.global_client_id
                                ,p.global_person_id
								,p.platform_id
                                ,p.client_id, p.client_id_string
                                ,p.platform_person_internal_id
                                ,e.expected_annual_base_salary as salary
                                ,e.hourly_salary_status
                                ,e.fulltime_parttime_status
                                ,e.employment_status
                                ,p.person_reason_code
                                ,p.union_name
                                ,p.gender
								,p.FRST_NM
								,p.MID_NM
								,p.LAST_NM
								,p.birth_date
								,case WHEN p.person_reason_code = 'Employee'
                                  AND upper(e.employment_status_roll_up_1) <> 'ACTIVE'
                                  AND e.termination_date IS NOT NULL
                                  AND EXTRACT(YEAR FROM e.termination_date) <> 2299
                                   THEN e.termination_date else NULL END AS termination_date
								,e.hire_date
								,e.effective_begin_date
								,e.employee_id
								,e.employment_status_roll_up_1
                                ,FLOOR(CASE 
                                                WHEN p.birth_date IN (
                                                                                '1800-01-01'
                                                                                ,'1900-01-01'
                                                                                ,'1901-01-01'
                                                                                ,'1910-01-01'
                                                                                ,'1930-01-01'
                                                                                )
                                                                THEN NULL
                                                ELSE ROUND(DATEDIFF(DAY, p.birth_date, last_day(<<$pEndDate>>)) / 365.25, 2)
                                                END) AS age
                                ,CASE 
                                                WHEN p.person_reason_code = 'Employee'
                                                                AND upper(e.employment_status_roll_up_1) = 'ACTIVE'
                                                                THEN ROUND(DATEDIFF(DAY, e.hire_date, last_day(<<$pEndDate>>)) / 365.25, 2)
                                                WHEN p.person_reason_code = 'Employee'
                                                                AND upper(e.employment_status_roll_up_1) <> 'ACTIVE'
                                                                AND e.termination_date IS NOT NULL
                                                                AND EXTRACT(YEAR FROM e.termination_date) <> 2299
                                                                THEN ROUND(DATEDIFF(DAY, e.hire_date, e.termination_date) / 365.25, 2)
                                                ELSE NULL
                                                END AS tenure,
								 p.row_level_security_filter_value,
    pcf.custom_filter_1, pcf.custom_filter_2, pcf.custom_filter_3, pcf.custom_filter_4, pcf.custom_filter_5,BAD_ADDR_IND_CD
                FROM mv_person p
                left JOIN mv_person_employment e ON p.client_id = e.client_id
                                AND p.platform_person_internal_id = e.platform_person_internal_id
								AND p.platform_id = e.platform_id
                                --AND p.global_client_id = e.global_client_id
                                --AND p.global_person_id = e.global_person_id
                                 AND p.client_id = cast(<<$pClientId>> as int)
                
				left join pcf on p.platform_id = pcf.platform_id
								and p.platform_person_internal_id = pcf.platform_person_internal_id
								and p.client_id = pcf.client_id 
--								and p.begin_date <= pcf.end_date
--								and p.end_date >= pcf.begin_date
                
				
				)
--select * from person
,
range_lookup
AS (
                SELECT standard_group_key
                                ,standard_display_name standard_display_value
                                ,standard_min
                                ,standard_max
                                ,OWNER
                FROM adlfound_itg.standard_ranges_lookup
                )
,
db_person_attributes
AS (
SELECT 
a.client_id
,a.platform_id
,a.client_id_string
,a.platform_person_internal_id
,a.salary
,D.standard_display_value AS SALARY_RANGE
,a.hourly_salary_status
,a.fulltime_parttime_status
,a.employment_status
,a.person_reason_code
,a.union_name
,a.gender
,a.age
,B.standard_display_value AS AGE_RANGE
,a.tenure
,C.standard_display_value AS TENURE_RANGE
,a.row_level_security_filter_value
,a.custom_filter_1
,a.custom_filter_2
,a.custom_filter_3
,a.custom_filter_4
,a.custom_filter_5
,a.BAD_ADDR_IND_CD
,a.FRST_NM
,a.MID_NM
,a.LAST_NM
,a.birth_date
,a.termination_date
,a.hire_date
,a.effective_begin_date
,a.employee_id
                FROM person a
                LEFT JOIN (
                                SELECT *
                                FROM range_lookup
                                WHERE standard_group_key = 'AGE_RANGE_DB'
                                ) b ON floor(a.age) between b.standard_min AND b.standard_max 
                LEFT JOIN (
                                SELECT *
                                FROM range_lookup
                                WHERE standard_group_key = 'TENURE'
                                ) C ON floor(a.tenure) between C.standard_min AND C.standard_max 
                LEFT JOIN (
                                SELECT *
                                FROM range_lookup
                                WHERE standard_group_key = 'SALARY_RANGE_WEALTH'
                                ) D ON floor(a.salary) between D.standard_min AND D.standard_max 
                )
--select * from db_person_attributes
, 
db_plan_dim as (
select distinct client_id,plan_id,plan_ldsc_tx
from wealth_rpt.db_plan_dim 
where client_id=<<$pClientId>>
)
--select * from db_plan_dim
,

PRSN_PLANSTAT_DIMN01
AS (
 SELECT a.client_id AS CLIENT_ID
 ,a.platform_id
  ,a.platform_person_internal_id AS PRSN_INTN_ID
  ,plan_status_description 
  ,a.plan_id AS PLAN_ID
  ,c.plan_ldsc_tx as Plan_Description
 FROM wealth_rpt.person_planstatus_dim a
 INNER JOIN wealth_rpt.dc_category_dim b ON a.client_id = b.client_id
  AND a.category_id = b.category_id
  AND a.plan_id = b.plan_id
 INNER JOIN wealth_rpt.db_plan_dim c on  a.client_id = c.client_id
  AND a.plan_id = c.plan_id
 WHERE
  a.platform_indicator_code IN ('R3','R4','DBE') 
  AND b.category_type_code = 'PS'
  AND <<$pEndDate>> >= a.begin_date
  AND <<$pEndDate>> <= a.end_date
  AND b.category_definition_brand_code = 'DB-AVLB'
  AND a.client_id =<<$pClientId>>
 ),
 
Shortcut_to_Person_Elec_Fact AS 
    (
    SELECT
	 DB_PRSN_ELEC_FACT5.client_id,
	 DB_PRSN_ELEC_FACT5.platform_id,
        DB_PRSN_ELEC_FACT5.platform_person_internal_id AS PRSN_INTN_ID, 
        DB_PRSN_ELEC_FACT5.plan_id AS PLAN_ID, 
        DB_PRSN_ELEC_FACT5.db_election_id AS DB_ELEC_ID, 
        DB_PRSN_ELEC_FACT5.db_election_use_code AS DB_ELEC_USE_CD, 
        DB_PRSN_ELEC_FACT5.db_election_state_code AS DB_ELEC_STAT_CD, 
        DB_PRSN_ELEC_FACT5.service_period_end_date AS SV_PRD_END_DT,
		DB_Election_Dimension.db_election_long as Election_Description
    FROM
        wealth_itg.db_person_election_detail DB_PRSN_ELEC_FACT5 
		FULL OUTER JOIN wealth_itg.db_election_dim DB_Election_Dimension
                    ON DB_PRSN_ELEC_FACT5.db_election_id = DB_Election_Dimension.db_election_id
					and DB_PRSN_ELEC_FACT5.client_id = DB_Election_Dimension.client_id
    WHERE 
        DB_PRSN_ELEC_FACT5.db_election_use_code = 'D' AND
        DB_PRSN_ELEC_FACT5.db_election_state_code IN ( 
            'C', 
            'V' )
			and DB_PRSN_ELEC_FACT5.client_id=<<$pClientId>>    )
-- select * from Shortcut_to_Person_Elec_Fact
,
			
Shortcut_to_Pension_Popu_Elig_Current_All AS 
    (
    SELECT
	DB_ELIG_A_FACT11.client_id,
	DB_ELIG_A_FACT11.platform_id,
	DB_ELIG_A_FACT11.begin_date,
	DB_ELIG_A_FACT11.end_date,
        DB_ELIG_A_FACT11.platform_person_internal_id AS PRSN_INTN_ID, 
        DB_ELIG_A_FACT11.plan_id AS PLAN_ID, 
        DB_ELIG_A_FACT11.participation_date AS PARTICIPATION_DT, 
        DB_ELIG_A_FACT11.early_retirement_date AS EARLY_RETIRE_DT, 
        DB_ELIG_A_FACT11.normal_retirement_date AS NORMAL_RETIRE_DT, 
        DB_ELIG_A_FACT11.fully_vested_date AS C_100_VESTED_DT
		
    FROM
        wealth_rpt.db_person_plan DB_ELIG_A_FACT11 
    WHERE 
CASE 
            WHEN  <<$pBeginDate>> = CURRENT_DATE THEN DATEADD(day,-1, CURRENT_DATE)
            WHEN  <<$pBeginDate>> <>  <<$pEndDate>> THEN  <<$pBeginDate>> else <<$pBeginDate>>
        END <= DB_ELIG_A_FACT11.end_date AND
        CASE 
            WHEN  <<$pEndDate>> = CURRENT_DATE THEN DATEADD(day,-1, CURRENT_DATE)
            WHEN  <<$pEndDate>> <>  <<$pBeginDate>> THEN  <<$pEndDate>> else <<$pEndDate>>
        END >= DB_ELIG_A_FACT11.begin_date 
	   and DB_ELIG_A_FACT11.client_id=<<$pClientId>>
    ),
	
	-- select * from Shortcut_to_Pension_Popu_Elig_Current_All

main as
(SELECT
Person.client_id_string,
    Person.platform_person_internal_id AS  platform_person_internal_id,
	Person.client_id,
	Person.platform_id,
    Person.LAST_NM AS Last_Name, 
	Person.MID_NM as Middle_name,
    Person.FRST_NM AS First_Name, 
    db_plan_dim.plan_ldsc_tx AS Pension_Plan, 
	PRSN_PLANSTAT_DIMN01.plan_status_description,
    Person.person_reason_code AS Person_Type, 
    Person.employment_status AS Employment_Status, 
    Person.effective_begin_date AS Employment_Status_Begin_Date, 
    Shortcut_to_Pension_Popu_Elig_Current_All.PARTICIPATION_DT AS Participation_Date, 
    Shortcut_to_Pension_Popu_Elig_Current_All.C_100_VESTED_DT AS C100__Vested_Date, 
--Shortcut_to_Pension_Popu_Elig_Current_All.begin_date,
--Shortcut_to_Pension_Popu_Elig_Current_All.end_date,
    CASE 
        WHEN Shortcut_to_Person_Elec_Fact.DB_ELEC_USE_CD = 'D' THEN 'Deferred'
        ELSE NULL
    END AS DB_Election_Use_Code, 
    CASE 
        WHEN Shortcut_to_Person_Elec_Fact.DB_ELEC_STAT_CD = 'C' THEN 'Computed'
        WHEN Shortcut_to_Person_Elec_Fact.DB_ELEC_STAT_CD = 'V' THEN 'Converted'
        ELSE NULL
   END AS DB_Election_Stat_Code, 
    Shortcut_to_Person_Elec_Fact.Election_Description AS Election_Description, 
    Shortcut_to_Person_Elec_Fact.SV_PRD_END_DT AS Service_Period_End_Date, 
    Shortcut_to_Pension_Popu_Elig_Current_All.NORMAL_RETIRE_DT AS Normal_Retirement_Date, 
    Shortcut_to_Pension_Popu_Elig_Current_All.EARLY_RETIRE_DT AS Early_Retirement_Date,
salary,
SALARY_RANGE,
hourly_salary_status,
fulltime_parttime_status,
union_name,
gender,
age,
AGE_RANGE,
tenure,
TENURE_RANGE,
row_level_security_filter_value,
birth_date,
employee_id,
custom_filter_1,
custom_filter_2,
custom_filter_3,
custom_filter_4,
custom_filter_5
FROM
	db_person_attributes Person
					left outer join Shortcut_to_Person_Elec_Fact
					on Person.platform_person_internal_id = Shortcut_to_Person_Elec_Fact.PRSN_INTN_ID
					and Person.platform_id=Shortcut_to_Person_Elec_Fact.platform_id
					LEFT OUTER JOIN Shortcut_to_Pension_Popu_Elig_Current_All
                ON 
                    Shortcut_to_Person_Elec_Fact.PRSN_INTN_ID = Shortcut_to_Pension_Popu_Elig_Current_All.PRSN_INTN_ID AND
                    Shortcut_to_Person_Elec_Fact.plan_id = Shortcut_to_Pension_Popu_Elig_Current_All.plan_id
					and Shortcut_to_Person_Elec_Fact.platform_id = Shortcut_to_Pension_Popu_Elig_Current_All.platform_id
					left outer join db_plan_dim
					on
					Shortcut_to_Person_Elec_Fact.PLAN_ID=db_plan_dim.plan_id
					left outer join PRSN_PLANSTAT_DIMN01 
					on PRSN_PLANSTAT_DIMN01.PLAN_ID=Shortcut_to_Person_Elec_Fact.PLAN_ID
					and PRSN_PLANSTAT_DIMN01.PRSN_INTN_ID=Shortcut_to_Person_Elec_Fact.PRSN_INTN_ID
					 and PRSN_PLANSTAT_DIMN01.platform_id=Shortcut_to_Person_Elec_Fact.platform_id

WHERE 
NOT ( db_plan_dim.plan_ldsc_tx  IS NULL )
AND
Shortcut_to_Person_Elec_Fact.DB_ELEC_USE_CD = 'D' AND
 Shortcut_to_Person_Elec_Fact.DB_ELEC_STAT_CD IN ( 'V','C' ) 
GROUP BY 
 
Person.client_id_string,
    Person.platform_person_internal_id , 
	Person.client_id,
	Person.platform_id,
    Person.LAST_NM , 
	Person.MID_NM, 
    Person.FRST_NM , 
    db_plan_dim.plan_ldsc_tx , 
	PRSN_PLANSTAT_DIMN01.plan_status_description,
    Person.person_reason_code , 
    Person.employment_status , 
    Person.effective_begin_date , 
    Shortcut_to_Pension_Popu_Elig_Current_All.PARTICIPATION_DT , 
    Shortcut_to_Pension_Popu_Elig_Current_All.C_100_VESTED_DT , 
--Shortcut_to_Pension_Popu_Elig_Current_All.begin_date,
--Shortcut_to_Pension_Popu_Elig_Current_All.end_date,
    CASE 
        WHEN Shortcut_to_Person_Elec_Fact.DB_ELEC_USE_CD = 'D' THEN 'Deferred'
        ELSE NULL
    END , 
   CASE 
        WHEN Shortcut_to_Person_Elec_Fact.DB_ELEC_STAT_CD = 'C' THEN 'Computed'
        WHEN Shortcut_to_Person_Elec_Fact.DB_ELEC_STAT_CD = 'V' THEN 'Converted'
        ELSE NULL
    END, 
    Shortcut_to_Person_Elec_Fact.Election_Description , 
    Shortcut_to_Person_Elec_Fact.SV_PRD_END_DT , 
    Shortcut_to_Pension_Popu_Elig_Current_All.NORMAL_RETIRE_DT , 
    Shortcut_to_Pension_Popu_Elig_Current_All.EARLY_RETIRE_DT ,
salary,
SALARY_RANGE,
hourly_salary_status,
fulltime_parttime_status,
union_name,
gender,
age,
AGE_RANGE,
tenure,
TENURE_RANGE,
row_level_security_filter_value,
birth_date,
employee_id,
custom_filter_1,
custom_filter_2,
custom_filter_3,
custom_filter_4,
custom_filter_5
)
select * from main
