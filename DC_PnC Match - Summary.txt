WITH mv_person
AS (
                SELECT DISTINCT global_client_id
                                ,global_person_id
                                ,client_id
								,client_id_string
                                ,platform_person_internal_id
								,platform_id
                                ,gender
                                ,birth_date
                                ,person_reason_code
                                ,union_name
								,row_level_security_filter_value
                FROM person_rpt.person
                WHERE person_reason_code = 'Employee'
                                AND begin_date <= last_day(<<$pAsOfDate>>)
                                AND end_date >= last_day(<<$pAsOfDate>>)
                                AND client_id =<<$pClientId>>
                )
                ,mv_person_employment
AS (
                SELECT DISTINCT global_client_id
		,global_person_id
		,client_id
		,platform_person_internal_id
		,platform_id
		,expected_annual_base_salary as salary
		,expected_annual_base_salary_begin_date as salary_begin_date
		,annual_payroll_frequency
		,hourly_salary_status
		,fulltime_parttime_status
		--,employment_status
		,begin_date
		,end_date
		,hire_date
		,termination_date
		,standard_value AS employment_status
		,standard_employment_status_code
FROM person_rpt.person_employment pe
LEFT OUTER JOIN adlfound_itg.standard_rollups_lookup rl
	ON pe.standard_employment_status_code = rl.standard_key
	AND standard_group_key in ('EMPL-STAT-CD-ROLLUP1')
	WHERE 
		begin_date <= last_day(<<$pAsOfDate>>)
		AND end_date >= last_day(<<$pAsOfDate>>)
		AND client_id =<<$pClientId>>
                )

                ,person
AS (
                SELECT p.global_client_id
                                ,p.global_person_id
                                ,p.client_id
								,p.client_id_string
                                ,p.platform_person_internal_id
                                ,e.salary
								,e.annual_payroll_frequency	
								,e.salary_begin_date
								,e.hourly_salary_status
                                ,e.fulltime_parttime_status
                                ,e.employment_status
								,e.standard_employment_status_code
                                ,p.person_reason_code
                                ,p.union_name
                                ,p.gender
								,p.row_level_security_filter_value
								,pcf.custom_filter_1
								,pcf.custom_filter_2
								,pcf.custom_filter_3
								,pcf.custom_filter_4
								,pcf.custom_filter_5
                                ,floor(CASE 
                                                WHEN p.birth_date IN (
                                                                                '1800-01-01'
                                                                                ,'1900-01-01'
                                                                                ,'1901-01-01'
                                                                                ,'1910-01-01'
                                                                                ,'1930-01-01'
                                                                                )
                                                                THEN NULL
                                                ELSE ROUND(DATEDIFF(DAY, p.birth_date, last_day(<<$pAsOfDate>>)) / 365, 0)
                                                END) AS age
                                ,CASE 
                                                WHEN p.person_reason_code = 'Employee'
                                                                AND upper(e.employment_status) = 'ACTIVE'
                                                                THEN ROUND(DATEDIFF(DAY, e.hire_date, last_day(<<$pAsOfDate>>)) / 365.25, 2)
                                                WHEN p.person_reason_code = 'Employee'
                                                                AND upper(e.employment_status) <> 'ACTIVE'
                                                                AND e.termination_date IS NOT NULL
                                                                AND EXTRACT(YEAR FROM e.termination_date) <> 2299
                                                                THEN ROUND(DATEDIFF(DAY, e.hire_date, e.termination_date) / 365.25, 2)
                                                ELSE NULL
                                                END AS tenure
                FROM mv_person p
                inner JOIN mv_person_employment e ON p.client_id = e.client_id
                                AND p.platform_person_internal_id = e.platform_person_internal_id
								AND p.platform_id = e.platform_id
                                --AND p.global_client_id = e.global_client_id
                                --AND p.global_person_id = e.global_person_id
                                AND p.client_id =<<$pClientId>>
				
				left join person_itg.person_custom_filter pcf on p.platform_id = pcf.platform_id
						and p.platform_person_internal_id = pcf.platform_person_internal_id
						and p.client_id = pcf.client_id
						and <<$pAsOfDate>> <= pcf.end_date
						and <<$pAsOfDate>> >= pcf.begin_date
						--and pcf.client_id =cast(<<$pClientId>> as int)
						and pcf.client_id =cast(<<$pClientId>> as int)	
						and pcf.data_product = 'DC'
				
				where upper(trim(e.employment_status)) in  ('ACTIVE')
				
				
				
                ),
prsn_planstat_dimn01
AS (
	SELECT a.client_id AS client_id
		,a.platform_person_internal_id AS platform_person_internal_id
		,a.category_id AS category_id
		,a.begin_date AS begin_date
		,a.end_date AS end_date
		,a.plan_status_code AS plan_status_code
		,a.participation_status_code AS participation_status_code
		,a.platform_indicator_code AS platform_indicator_code
		,a.plan_id AS plan_id
		,b.category_type_code AS category_type_code
		,MAX(begin_date) OVER (
			PARTITION BY a.client_id
			,a.plan_id
			,a.platform_person_internal_id
			,a.category_id
			) AS max_begin_date
	FROM wealth_rpt.person_planstatus_dim a
	INNER JOIN wealth_rpt.dc_category_dim b ON a.client_id = b.client_id
		AND a.category_id = b.category_id
		AND a.plan_id = b.plan_id
	WHERE
		a.platform_indicator_code IN ('R3','R4','DCE') 
		AND b.category_type_code = 'PS'
		AND last_day(<<$pAsOfDate>>) >= a.begin_date
		AND last_day(<<$pAsOfDate>>) <= a.end_date
		AND b.category_definition_brand_code = 'PRTC-STAT'
		AND a.client_id =<<$pClientId>>
	)
	,prsn_planstat_dimn
AS (
	SELECT DISTINCT client_id
		,plan_id
		,category_id
		,platform_person_internal_id
		,participation_status_code
		,platform_indicator_code
		,max_begin_date
	FROM prsn_planstat_dimn01
	WHERE max_begin_date = begin_date
	--and upper(trim(participation_status_code)) in  ('ACTIVE','ELIG')
	)
,person_data
AS (
	SELECT p.global_client_id
		,p.global_person_id
		,p.client_id
		,p.client_id_string
		,p.platform_person_internal_id
		,p.salary
		,p.annual_payroll_frequency
		,p.salary_begin_date
		,p.hourly_salary_status
		,p.fulltime_parttime_status
		,p.person_reason_code
		,p.union_name
		,p.gender
		,p.employment_status
		,p.standard_employment_status_code
		,p.age
		,p.tenure
		,p.row_level_security_filter_value
		,p.custom_filter_1
		,p.custom_filter_2
		,p.custom_filter_3
		,p.custom_filter_4
		,p.custom_filter_5
		,d.participation_status_code
		,d.platform_indicator_code
		,d.plan_id
	FROM prsn_planstat_dimn d
	INNER JOIN person p ON p.client_id = d.client_id
		AND p.platform_person_internal_id = d.platform_person_internal_id
	)
                ,range_lookup
AS (
                SELECT standard_group_key
                                ,standard_display_name
                                ,standard_min
                                ,standard_max
                                ,OWNER
                FROM adlfound_itg.standard_ranges_lookup
                )
                ,dc_person_attributes
AS (
                SELECT a.client_id
								,a.client_id_string
                                ,a.platform_person_internal_id
                                ,a.hourly_salary_status
                                ,a.fulltime_parttime_status
                                ,a.person_reason_code
                                ,a.union_name
                                ,a.gender
								,a.plan_id
                                ,a.employment_status
								,a.participation_status_code
								,a.standard_employment_status_code
                                ,a.age
                                ,B.standard_display_name AS AGE_RANGE
                                ,a.TENURE
                                ,C.standard_display_name AS TENURE_RANGE
                                ,a.salary
								,a.annual_payroll_frequency
								,a.salary_begin_date
                                ,D.standard_display_name AS SALARY_RANGE
								,a.row_level_security_filter_value
								,a.custom_filter_1
								,a.custom_filter_2
								,a.custom_filter_3
								,a.custom_filter_4
								,a.custom_filter_5
                FROM person_data a
           LEFT JOIN (
                                SELECT *
                                FROM range_lookup
                                WHERE standard_group_key = 'AGE_RANGE_DC'
                                ) b ON floor(a.age)BETWEEN (b.standard_min)
                                                AND(b.standard_max)
                LEFT JOIN (
                                SELECT *
                                FROM range_lookup
                                WHERE standard_group_key = 'TENURE'
                                ) C ON floor(a.tenure) BETWEEN (C.standard_min)
                                                AND (C.standard_max)
                LEFT JOIN (
                                SELECT *
                                FROM range_lookup
                                WHERE standard_group_key = 'SALARY_RANGE_WEALTH'
                                ) D ON floor (a.salary) BETWEEN (D.standard_min)
                                                AND (D.standard_max)
                ),
dc_contributions_ppts AS (
 SELECT 
 client_id, 
 plan_id, 
 platform_person_internal_id, 
 contribution_rate_id,
 begin_date,
 actual_contribution_rate,
 actual_contribution_amount,
 ROW_NUMBER() OVER (
 PARTITION BY client_id, plan_id, platform_person_internal_id, contribution_rate_id 
 ORDER BY begin_date DESC
 ) AS rn
 FROM wealth_itg.dc_contributions
 WHERE client_id = <<$pClientId>>
 AND <<$pAsOfDate>> BETWEEN begin_date AND end_date
 AND contribution_rate_type_code IN ('AT', 'BT', 'RT')
),
dc_contributions AS (
select client_id, plan_id, platform_person_internal_id, 
sum(actual_contribution_rate) as actual_contribution_rate,
sum(actual_contribution_amount) as actual_contribution_amount
from dc_contributions_ppts    
WHERE rn = 1
group by client_id, plan_id, platform_person_internal_id
),


dc_ctrb_bal AS (
select pa.client_id, pa.client_id_string, pa.plan_id, pa.platform_person_internal_id, pa.AGE_RANGE,pa.TENURE_RANGE,pa.SALARY_RANGE,pa.gender,
pa.participation_status_code,pa.employment_status,pa.standard_employment_status_code,
pa.row_level_security_filter_value, pa.custom_filter_1, pa.custom_filter_2, pa.custom_filter_3, pa.custom_filter_4, pa.custom_filter_5,
CASE 
 WHEN (dc.actual_contribution_rate = 0 OR dc.actual_contribution_rate IS NULL) 
 AND dc.actual_contribution_amount > 0 THEN 
 CASE 
 WHEN pa.salary_begin_date <= <<$pAsOfDate>> THEN
 CASE 
 WHEN (pa.salary IS NULL OR pa.salary = 0) 
 OR (pa.annual_payroll_frequency IS NULL OR pa.annual_payroll_frequency = 0) THEN 0
 ELSE (dc.actual_contribution_amount / (pa.salary / pa.annual_payroll_frequency)) * 100
 END
 ELSE 0
 END
 ELSE dc.actual_contribution_rate
END AS actual_contribution_rate,

dc.actual_contribution_amount, icb.match_threshold_percent
from dc_person_attributes pa
left join dc_contributions dc
on pa.client_id=dc.client_id
and pa.plan_id=dc.plan_id
and pa.platform_person_internal_id=dc.platform_person_internal_id
left join wealth_itg.dc_icb_plan_dim icb
on pa.client_id=icb.client_id
and pa.plan_id=icb.plan_id
and icb.reporting_year=EXTRACT(YEAR FROM (CAST(<<$pAsOfDate>> AS DATE)))
),
dc_ctrb AS (
select client_id, client_id_string, plan_id, platform_person_internal_id, AGE_RANGE, TENURE_RANGE, SALARY_RANGE, gender,
participation_status_code,employment_status,standard_employment_status_code, actual_contribution_rate, actual_contribution_amount,  match_threshold_percent,
row_level_security_filter_value, custom_filter_1, custom_filter_2, custom_filter_3, custom_filter_4, custom_filter_5,
case when match_threshold_percent > nvl(actual_contribution_rate,0) then 'Below'
          when match_threshold_percent < nvl(actual_contribution_rate,0) then 'Above'
          when match_threshold_percent = nvl(actual_contribution_rate,0) then 'Equal'
else 'NA'
end AS match_threshhold_flag
from dc_ctrb_bal
),

dc_ctrb_final AS (
select * from dc_ctrb
where upper(trim(employment_status))='ACTIVE' AND upper(trim(participation_status_code)) in ('ACTIVE','ELIG') and 
actual_contribution_rate > 0

),
matchthreshold_count AS (
select client_id, client_id_string, plan_id, AGE_RANGE, TENURE_RANGE, SALARY_RANGE, gender,
row_level_security_filter_value, custom_filter_1, custom_filter_2, custom_filter_3, custom_filter_4, custom_filter_5,
COUNT(DISTINCT CASE WHEN UPPER(TRIM(match_threshhold_flag)) = 'ABOVE' THEN platform_person_internal_id END) AS Above_match_ppts,
COUNT(DISTINCT CASE WHEN UPPER(TRIM(match_threshhold_flag)) = 'EQUAL' THEN platform_person_internal_id END) AS Equal_match_ppts,
COUNT(DISTINCT CASE WHEN UPPER(TRIM(match_threshhold_flag)) = 'BELOW' THEN platform_person_internal_id END) AS Below_match_ppts,
count(distinct platform_person_internal_id) AS total_ppts 
from dc_ctrb_final
group by client_id, client_id_string, plan_id, AGE_RANGE, TENURE_RANGE, SALARY_RANGE, gender, row_level_security_filter_value, custom_filter_1, custom_filter_2, custom_filter_3, custom_filter_4, custom_filter_5
)
select mt.client_id, mt.client_id_string, pln.plan_long_description as plan_name, AGE_RANGE, TENURE_RANGE, SALARY_RANGE, gender,
mt.row_level_security_filter_value, mt.custom_filter_1, mt.custom_filter_2, mt.custom_filter_3, mt.custom_filter_4, mt.custom_filter_5,
mt.Above_match_ppts,
Round(mt.Above_match_ppts*100::DECIMAL/nullif(mt.total_ppts,0),1) as Percent_of_Above_match_ppts,
mt.Equal_match_ppts,
Round(mt.Equal_match_ppts*100::DECIMAL/nullif(mt.total_ppts,0),1) as Percent_of_Equal_match_ppts,
mt.Below_match_ppts,
Round(mt.Below_match_ppts*100::DECIMAL/nullif(mt.total_ppts,0),1) as Percent_of_Below_match_ppts
from matchthreshold_count mt
inner join
wealth_rpt.dc_plan_dim pln
on mt.client_id = pln.client_id
and mt.plan_id = pln.plan_id
where pln.client_id=<<$pClientId>>